<div class="modal fade" id="resetModal" tabindex="-1" aria-hidden="true" style="overflow: hidden;">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 400px; margin-top: -150px; max-height: 90vh; overflow: hidden; margin-left: 600px;">
    <div class="modal-content" style="border: none; border-radius: 10px; overflow: hidden; max-height: 85vh;">
      <div class="modal-body" style="padding: 1.5rem; overflow-y: auto; max-height: calc(85vh - 60px);">
        <form method="post" id="modalResetPasswordForm" class="needs-validation" novalidate
              action="{% url 'reset_password' %}?modal=true"
              style="width: 100%; max-width: 600px; margin: 0 auto; margin-bottom: -20px;"
              autocomplete="off">
          {% csrf_token %}

          <div class="text-center mb-3">
            <h3 class="fw-bold mb-1" style="color: #2c3e50; font-size: 1.5rem;">Reset Your Password</h3>
            <p style="color: #7f8c8d; font-size: 0.85rem; margin-bottom: 0;">Enter your credentials to reset password</p>
          </div>

          <div id="globalAlert" class="alert d-none mb-3" style="border-radius: 8px; padding: 12px 16px; font-size: 0.85rem; border: none; animation: slideDown 0.3s ease;">
            <div class="d-flex align-items-center">
              <i class="alert-icon me-2" style="font-size: 1rem;"></i>
              <div class="alert-message flex-grow-1"></div>
              <button type="button" class="btn-close btn-close-sm ms-2" onclick="hideGlobalAlert()" style="font-size: 0.7rem;"></button>
            </div>
          </div>

          <style>
            .offscreen-bait {
              position: absolute !important;
              left: -10000px !important;
              top: auto !important;
              width: 1px !important;
              height: 1px !important;
              overflow: hidden !important;
              opacity: 0 !important;
              pointer-events: none !important;
            }
          </style>
          <div class="offscreen-bait" aria-hidden="true">
            <input type="text" name="username" class="bait" autocomplete="username" tabindex="-1">
            <input type="password" name="password" class="bait" autocomplete="current-password" tabindex="-1">
          </div>

          <div class="mb-2">
            <label for="resetUsername" class="form-label" style="color: #2c3e50; font-weight: 500; font-size: 0.85rem; margin-bottom: 4px;">Username</label>
            <div class="input-group" style="height: 42px;">
              <span class="input-group-text" style="background-color: #f8f9fa; color: #7f8c8d; border: 1px solid #dfe6e9; border-right: none; border-radius: 6px 0 0 6px; padding: 10px 12px; font-size: 0.9rem;">@</span>
              <input
                type="text"
                id="resetUsername"
                name="reset_username"
                class="form-control"
                placeholder="username"
                required
                minlength="4"
                maxlength="20"
                pattern="[A-Za-z0-9]{4,20}"
                style="background-color: #f8f9fa; color: #2c3e50; border: 1px solid #dfe6e9; border-left: none; border-radius: 0 6px 6px 0; padding: 10px 12px; font-size: 0.9rem; height: 100%;"
                aria-label="Username"
                autocomplete="off"
                autocapitalize="off"
                autocorrect="off"
                spellcheck="false"
              >
            </div>
            <div class="field-error-message" style="font-size: 0.8rem; margin-top: 4px; display: none;"></div>
          </div>

          <div class="mb-3">
            <label for="oldPassword" class="form-label mb-1" style="color: #2c3e50; font-weight: 500; font-size: 0.85rem;">Current Password</label>
            <input
              type="password"
              id="oldPassword"
              name="reset_old_password"
              class="form-control"
              placeholder="••••••••"
              required
              style="background-color: #f8f9fa; color: #2c3e50; border: 1px solid #dfe6e9; border-radius: 6px; padding: 10px 12px; font-size: 0.9rem; height: 42px;"
              aria-label="Current password"
              autocomplete="new-password"
              autocapitalize="off"
              autocorrect="off"
              spellcheck="false"
            >
            <div class="field-error-message mt-1" style="color: #e74c3c; font-size: 0.75rem; display: none;"></div>
          </div>

          <div class="mb-3">
            <label for="newPassword1" class="form-label mb-1" style="color: #2c3e50; font-weight: 500; font-size: 0.85rem;">New Password</label>
            <input
              type="password"
              id="newPassword1"
              name="reset_new_password1"
              class="form-control"
              placeholder="••••••••"
              required
              minlength="8"
              style="background-color: #f8f9fa; color: #2c3e50; border: 1px solid #dfe6e9; border-radius: 6px; padding: 10px 12px; font-size: 0.9rem; height: 42px;"
              aria-label="New password"
              autocomplete="new-password"
              autocapitalize="off"
              autocorrect="off"
              spellcheck="false"
            >
            <div class="password-strength mt-2">
              <div class="progress" style="height: 4px; background-color: #f1f2f6; border-radius: 2px;">
                <div class="progress-bar" role="progressbar" style="width: 0%; transition: width 0.3s ease;"></div>
              </div>
              <small class="password-hint d-block mt-1 text-muted" style="font-size: 0.75rem;">
                Use 8 or more characters with a mix of letters, numbers & symbols
              </small>
            </div>
            <div class="field-error-message mt-1" style="color: #e74c3c; font-size: 0.75rem; display: none;"></div>
          </div>

          <div class="mb-3">
            <label for="newPassword2" class="form-label mb-1" style="color: #2c3e50; font-weight: 500; font-size: 0.85rem;">Confirm New Password</label>
            <input
              type="password"
              id="newPassword2"
              name="reset_new_password2"
              class="form-control"
              placeholder="••••••••"
              required
              style="background-color: #f8f9fa; color: #2c3e50; border: 1px solid #dfe6e9; border-radius: 6px; padding: 10px 12px; font-size: 0.9rem; height: 42px;"
              aria-label="Confirm new password"
              autocomplete="new-password"
              autocapitalize="off"
              autocorrect="off"
              spellcheck="false"
            >
            <div class="field-error-message mt-1" style="color: #e74c3c; font-size: 0.75rem; display: none;"></div>
          </div>

          <input type="hidden" name="username" id="real_username">
          <input type="hidden" name="old_password" id="real_old_password">
          <input type="hidden" name="new_password1" id="real_new_password1">
          <input type="hidden" name="new_password2" id="real_new_password2">

          <button type="submit" class="btn btn-primary w-100 py-2 mb-2 fw-bold"
                  style="background-color: #3498db; border: none; border-radius: 6px; font-size: 0.9rem; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2); height: 42px; transition: all 0.3s ease;">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="button-text">Reset Password</span>
          </button>

          <div class="text-center mt-2">
            <p style="color: #7f8c8d; font-size: 0.85rem; margin-bottom: 0;">
              Remember your password?
              <a href="{% url 'login' %}" class="text-primary text-decoration-none fw-bold" style="color: #3498db !important;">Sign in</a>
            </p>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.form-control::placeholder,
input::placeholder,
textarea::placeholder { color: #98a2b3 !important; opacity: 1 !important; }
.form-control::-webkit-input-placeholder,
input::-webkit-input-placeholder { color: #98a2b3 !important; opacity: 1 !important; }
.form-control::-moz-placeholder,
input::-moz-placeholder { color: #98a2b3 !important; opacity: 1 !important; }
.form-control:-ms-input-placeholder,
input:-ms-input-placeholder { color: #98a2b3 !important; opacity: 1 !important; }

@keyframes slideDown { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
@keyframes shake { 0%,100% { transform: translateX(0) } 25% { transform: translateX(-5px) } 75% { transform: translateX(5px) } }
.field-error { border-color: #e74c3c !important; box-shadow: 0 0 0 0.1rem rgba(231, 76, 60, 0.25) !important; }
.field-success { border-color: #27ae60 !important; box-shadow: 0 0 0 0.1rem rgba(39, 174, 96, 0.25) !important; }
.shake-animation { animation: shake 0.5s ease-in-out; }
.btn:disabled { opacity: 0.7; cursor: not-allowed; }
.field-error-message { color:#e74c3c; font-size:.75rem; margin-top:4px; display:flex; align-items:center; animation:slideDown .3s ease; }
.field-error-message::before { content:"⚠"; margin-right:4px; font-size:.8rem; }

.password-strength .progress-bar.bg-danger { background: linear-gradient(90deg,#dc3545,#e55a5a) !important; }
.password-strength .progress-bar.bg-warning { background: linear-gradient(90deg,#ffc107,#ffca2c) !important; }
.password-strength .progress-bar.bg-success { background: linear-gradient(90deg,#28a745,#34ce57) !important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('modalResetPasswordForm');

  const usernameInput = document.getElementById('resetUsername');
  const oldPasswordInput = document.getElementById('oldPassword');
  const newPassword1 = document.getElementById('newPassword1');
  const newPassword2 = document.getElementById('newPassword2');

  const realUsername = document.getElementById('real_username');
  const realOldPassword = document.getElementById('real_old_password');
  const realNewPassword1 = document.getElementById('real_new_password1');
  const realNewPassword2 = document.getElementById('real_new_password2');

  [usernameInput, oldPasswordInput, newPassword1, newPassword2].forEach(el => {
    el.setAttribute('readonly', 'readonly');
    el.addEventListener('focus', () => el.removeAttribute('readonly'), { once: true });
  });

  window.addEventListener('pageshow', function() {
    [usernameInput, oldPasswordInput, newPassword1, newPassword2].forEach(el => {
      if (el && el.value) el.value = '';
    });
  });

  function showGlobalAlert(message, type = 'danger') {
    const alertContainer = document.getElementById('globalAlert');
    const alertIcon = alertContainer.querySelector('.alert-icon');
    const alertMessage = alertContainer.querySelector('.alert-message');

    alertContainer.className = `alert alert-${type} mb-3`;
    alertContainer.style.cssText = 'border-radius: 8px; padding: 12px 16px; font-size: 0.85rem; border: none; animation: slideDown 0.3s ease;';

    const iconClass = type === 'success' ? 'fa-check-circle'
                     : type === 'warning' ? 'fa-exclamation-triangle'
                     : 'fa-exclamation-circle';
    alertIcon.className = `fas ${iconClass} me-2`;

    alertMessage.innerHTML = message;
    alertContainer.classList.remove('d-none');

    if (type === 'success') {
      setTimeout(() => { hideGlobalAlert(); }, 5000);
    }
  }
  window.hideGlobalAlert = function () {
    const alertContainer = document.getElementById('globalAlert');
    alertContainer.classList.add('d-none');
  };

  function showFieldError(fieldName, message) {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (!field) return;
    const wrapper = field.closest('.mb-2, .mb-3') || field.parentElement;
    const errorElement = wrapper.querySelector('.field-error-message');
    if (errorElement) {
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      field.classList.add('field-error', 'shake-animation');
      setTimeout(() => field.classList.remove('shake-animation'), 500);
    }
  }
  function clearFieldError(fieldName) {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (!field) return;
    const wrapper = field.closest('.mb-2, .mb-3') || field.parentElement;
    const errorElement = wrapper.querySelector('.field-error-message');
    if (errorElement) {
      errorElement.style.display = 'none';
      field.classList.remove('field-error');
    }
  }
  function clearAllErrors() {
    hideGlobalAlert();
    form.querySelectorAll('.field-error-message').forEach(el => el.style.display = 'none');
    form.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
  }

  usernameInput.addEventListener('input', function () {
    clearFieldError('reset_username');
    validatePasswordSimilarity();
  });
  oldPasswordInput.addEventListener('input', function () {
    clearFieldError('reset_old_password');
  });
  newPassword1.addEventListener('input', function () {
    clearFieldError('reset_new_password1');
    validatePasswordSimilarity();
    updatePasswordStrength();
    validatePasswordMatch();
  });
  newPassword2.addEventListener('input', function () {
    clearFieldError('reset_new_password2');
    validatePasswordMatch();
  });

  form.addEventListener('invalid', function (e) {
    e.preventDefault();
  }, true);

  function validateRequiredFields() {
    let ok = true;

    const u = usernameInput.value.trim();
    if (u.length === 0) {
      showFieldError('reset_username', 'Username is required.');
      ok = false;
    } else if (u.length < 4) {
      showFieldError('reset_username', 'Username must be at least 4 characters.');
      ok = false;
    } else if (!/^[A-Za-z0-9]{4,20}$/.test(u)) {
      showFieldError('reset_username', 'Use 4–20 letters or numbers only (no spaces or symbols).');
      ok = false;
    }

    if (oldPasswordInput.value.length === 0) {
      showFieldError('reset_old_password', 'Current password is required.');
      ok = false;
    }

    if (newPassword1.value.length === 0) {
      showFieldError('reset_new_password1', 'New password is required.');
      ok = false;
    } else if (newPassword1.value.length > 0 && newPassword1.value.length < 8) {
      showFieldError('reset_new_password1', 'Password must be at least 8 characters.');
      ok = false;
    }

    if (newPassword2.value.length === 0) {
      showFieldError('reset_new_password2', 'Password confirmation is required.');
      ok = false;
    } else if (newPassword1.value && newPassword2.value && newPassword1.value !== newPassword2.value) {
      showFieldError('reset_new_password2', "Passwords don't match.");
      ok = false;
    }

    return ok;
  }

  function validatePasswordSimilarity() {
    const username = usernameInput.value.toLowerCase();
    const password = newPassword1.value.toLowerCase();

    if (username && password.includes(username)) {
      showFieldError('reset_new_password1', 'Password should not contain your username.');
      return false;
    }

    const commonPasswords = ['password', '12345678', 'qwerty', 'admin', 'letmein'];
    if (commonPasswords.includes(password)) {
      showFieldError('reset_new_password1', 'Password is too common.');
      return false;
    }

    if (/^\d+$/.test(password) && password.length > 0) {
      showFieldError('reset_new_password1', 'Password cannot be entirely numeric.');
      return false;
    }

    return true;
  }

  function validatePasswordMatch() {
    if (newPassword1.value && newPassword2.value && newPassword1.value !== newPassword2.value) {
      showFieldError('reset_new_password2', "Passwords don't match.");
      return false;
    } else if (newPassword1.value && newPassword2.value && newPassword1.value === newPassword2.value) {
      clearFieldError('reset_new_password2');
      newPassword2.classList.add('field-success');
      setTimeout(() => newPassword2.classList.remove('field-success'), 2000);
    }
    return true;
  }

  function updatePasswordStrength() {
    const container = document.querySelector('.password-strength');
    if (!container) return;
    const progressBar = container.querySelector('.progress-bar');
    const hintText = container.querySelector('.password-hint');

    const password = newPassword1.value;
    const strength = calculatePasswordStrength(password);

    if (progressBar) {
      progressBar.style.width = strength.percentage + '%';
      progressBar.className = 'progress-bar ' + strength.class;
    }

    if (hintText) {
      if (password.length === 0) {
        hintText.textContent = "Use 8 or more characters with a mix of letters, numbers & symbols";
        hintText.style.color = '#7f8c8d';
      } else if (password.length < 8) {
        hintText.textContent = "Password too short (min 8 characters)";
        hintText.style.color = '#e74c3c';
      } else if (strength.class === 'bg-danger') {
        hintText.textContent = "Weak password – add uppercase letters, numbers, or symbols";
        hintText.style.color = '#e74c3c';
      } else if (strength.class === 'bg-warning') {
        hintText.textContent = "Moderate password – could be stronger";
        hintText.style.color = '#f39c12';
      } else {
        hintText.textContent = "Strong password!";
        hintText.style.color = '#27ae60';
      }
    }
  }

  function calculatePasswordStrength(password) {
    let strength = 0;
    const hasLength = password.length >= 8;
    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasNumber = /\d/.test(password);
    const hasSpecial = /[^A-Za-z0-9]/.test(password);

    if (hasLength) strength += 20;
    if (hasUpper) strength += 20;
    if (hasLower) strength += 20;
    if (hasNumber) strength += 20;
    if (hasSpecial) strength += 20;

    let className = 'bg-danger';
    if (strength >= 60) className = 'bg-warning';
    if (strength >= 80) className = 'bg-success';

    return { percentage: Math.min(strength, 100), class: className };
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]');
    const spinner = submitBtn.querySelector('.spinner-border');
    const buttonText = submitBtn.querySelector('.button-text');

    clearAllErrors();

    const requiredOk = validateRequiredFields();
    const similarityOk = validatePasswordSimilarity();
    const matchOk = validatePasswordMatch();

    if (!requiredOk || !form.checkValidity() || !similarityOk || !matchOk) {
      return;
    }

    realUsername.value     = usernameInput.value.trim();
    realOldPassword.value  = oldPasswordInput.value;
    realNewPassword1.value = newPassword1.value;
    realNewPassword2.value = newPassword2.value;

    const baitU = form.querySelector('input.bait[name="username"]');
    const baitP = form.querySelector('input.bait[name="password"]');
    if (baitU) baitU.setAttribute('disabled', 'disabled');
    if (baitP) baitP.setAttribute('disabled', 'disabled');

    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    buttonText.textContent = 'Processing...';

    try {
        const formData = new FormData();
        const csrfEl = form.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfEl) formData.set('csrfmiddlewaretoken', csrfEl.value);

        formData.set('username',    usernameInput.value.trim());
        formData.set('old_password', oldPasswordInput.value);
        formData.set('new_password1', newPassword1.value);
        formData.set('new_password2', newPassword2.value);

        const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        credentials: 'same-origin' 
        });

      const data = await response.json();

      if (response.ok && data.success) {
        showGlobalAlert(data.message || 'Password successfully updated!', 'success');
        form.reset();
        buttonText.textContent = 'Success!';
        submitBtn.style.backgroundColor = '#27ae60';

        setTimeout(() => {
          if (data.redirect) {
            window.location.href = data.redirect;
          } else {
            const modal = bootstrap.Modal.getInstance(document.getElementById('resetModal'));
            if (modal) modal.hide();
            window.location.href = '/login/?password_reset=success';
          }
        }, 2000);

      } else {
        if (data.errors) {
          let hasFieldErrors = false;
          const fieldMap = {
            '__all__': 'global',
            'username': 'reset_username',
            'old_password': 'reset_old_password',
            'new_password1': 'reset_new_password1',
            'new_password2': 'reset_new_password2'
          };

          for (const [field, message] of Object.entries(data.errors)) {
            const mappedField = fieldMap[field] || field;
            if (mappedField === 'global' || field === '__all__') {
              showGlobalAlert(message, 'danger');
            } else {
              showFieldError(mappedField, message);
              hasFieldErrors = true;
            }
          }

          if (!hasFieldErrors && !data.errors.__all__) {
            showGlobalAlert(data.message || 'Please correct the errors below.', 'danger');
          }
        } else {
          showGlobalAlert(data.message || 'An error occurred. Please try again.', 'danger');
        }
      }
    } catch (error) {
      console.error('Error:', error);
      showGlobalAlert('Network error. Please check your connection and try again.', 'danger');
    } finally {
      const baitU2 = form.querySelector('input.bait[name="username"]');
      const baitP2 = form.querySelector('input.bait[name="password"]');
      if (baitU2) baitU2.removeAttribute('disabled');
      if (baitP2) baitP2.removeAttribute('disabled');

      submitBtn.disabled = false;
      spinner.classList.add('d-none');
      if (buttonText.textContent !== 'Success!') {
        buttonText.textContent = 'Reset Password';
        submitBtn.style.backgroundColor = '#3498db';
      }
    }
  });
});
</script>